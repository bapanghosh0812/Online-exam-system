<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Result</title>
<style>
  body{font-family:'Poppins',sans-serif;background:linear-gradient(-45deg,#ff9a9e,#fad0c4,#a1c4fd,#c2e9fb,#fbc2eb);background-size:1000% 1000%;animation:bgFlow 20s ease infinite;margin:0;padding:0;user-select:none;}
  @keyframes bgFlow{0%{background-position:0% 50%;}50%{background-position:100% 50%;}100%{background-position:0% 50%;}}
  header{background:linear-gradient(120deg,#ff9a9e,#fbc2eb,#a1c4fd,#c2e9fb);background-size:400% 400%;animation:bg 10s ease infinite;text-align:center;color:#fff;padding:15px;font-size:24px;font-weight:bold;display:flex;justify-content:space-between;align-items:center;}
  @keyframes bg{0%{background-position:0% 50%;}50%{background-position:100% 50%;}100%{background-position:0% 50%;}}
  .logout-btn{background:#e46033;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:600;}
  .container{padding:30px;text-align:center;}
  table{width:100%;max-width:700px;margin:20px auto;border-collapse:collapse;background:rgba(255,255,255,0.85);box-shadow:0 0 12px rgba(0,0,0,0.2);}
  th,td{padding:12px;border:1px solid #ddd;text-align:center;}
  th{background:#e46033;color:#fff;}
  .btn{background:#2563eb;color:#fff;padding:6px 12px;border:none;border-radius:6px;cursor:pointer;}
  .login-box{max-width:400px;margin:80px auto;padding:30px;background:rgba(0,0,0,0.7);color:#fff;border-radius:10px;box-shadow:0 0 12px rgba(0,0,0,0.6);}
  .login-box h2{text-align:center;margin-bottom:20px;}
  .input-box{margin:12px 0;text-align:left;}
  .input-box label{display:block;margin-bottom:5px;font-weight:500;}
  .input-box input{width:100%;padding:10px;border-radius:6px;border:1px solid #e46033;background:#1e1e1e;color:#fff;}
  .btn-login{width:100%;margin-top:15px;background:#e46033;border:none;padding:12px;border-radius:40px;color:#fff;font-weight:600;cursor:pointer;}
  .msg{text-align:center;margin-top:10px;font-weight:bold;color:#ffeb3b;}
</style>
</head>
<body>

<header>
  <div>üèõÔ∏è ABC Institute of Technology</div>
  <button id="logoutBtn" class="logout-btn" style="display:none;">Logout</button>
</header>

<div class="container">
  <div class="login-box" id="loginBox">
    <h2>Student Login</h2>
    <div class="input-box"><label>Roll Number</label><input type="text" id="roll"></div>
    <div class="input-box"><label>Password</label><input type="password" id="pass"></div>
    <button class="btn-login" onclick="login()">Login</button>
    <div class="msg" id="loginMsg"></div>
  </div>

  <div id="resultSection" style="display:none;">
    <table id="resultTable">
      <thead>
        <tr>
          <th>SL No</th>
          <th>Session</th>
          <th>Publication Date</th>
          <th>Grade Card</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const publishedKey="resultsPublished";

function login(){
  let roll=document.getElementById("roll").value.trim();
  let pass=document.getElementById("pass").value.trim();
  let users=JSON.parse(localStorage.getItem("current users"))||[];
  let user=users.find(u=>u.roll===roll && u.password===pass);

  if(user){
    localStorage.setItem("currentUser",JSON.stringify(user));
    document.getElementById("loginBox").style.display="none";
    document.getElementById("resultSection").style.display="block";
    document.getElementById("logoutBtn").style.display="inline-block";
    loadResults(user.roll);
  }else{
    document.getElementById("loginMsg").innerText="Invalid Roll or Password!";
  }
}

document.addEventListener("keydown",function(e){
  if(e.key==="Enter" && document.getElementById("loginBox").style.display!=="none"){ login(); }
});

document.getElementById("logoutBtn").onclick=function(){
  localStorage.removeItem("currentUser");
  window.location.replace("examination_system_page.html"); // ‚úÖ redirect
};

function loadResults(roll){
  const isPub=JSON.parse(localStorage.getItem(publishedKey)||"false");
  let allResults=JSON.parse(localStorage.getItem("allResults"))||[];
  let tbody=document.querySelector("#resultTable tbody");
  tbody.innerHTML="";

  if(!isPub){
    let tr=document.createElement("tr");
    tr.innerHTML=`<td colspan="4" style="color:red;font-weight:bold;">Results have not been published yet!</td>`;
    tbody.appendChild(tr);
    return;
  }

  let myPublished=allResults.filter(r=>r.roll===roll && r.published===true);
  if(myPublished.length===0){
    let tr=document.createElement("tr");
    tr.innerHTML=`<td colspan="4" style="color:red;font-weight:bold;">No results available!</td>`;
    tbody.appendChild(tr);
    return;
  }

  const groupsMap=new Map();
  myPublished.forEach(r=>{
    const sess=r.session||"-";
    const batch=Number(r.publishBatch||0);
    if(!batch) return;
    const key=`${sess}||${batch}`;
    if(!groupsMap.has(key)){
      groupsMap.set(key,{session:sess,batch,publicationDate:r.publicationDate});
    }
  });

  const groups=[...groupsMap.values()].sort((a,b)=>b.batch-a.batch);

  groups.forEach((g,idx)=>{
    const pubDate=g.publicationDate?new Date(g.publicationDate).toLocaleDateString():"-";
    let tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${idx+1}</td>
      <td>${g.session}</td>
      <td>${pubDate}</td>
      <td><button class="btn" onclick="openGradeCard('${g.session}', ${g.batch})">Grade Card</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function openGradeCard(session, batch){
  localStorage.setItem("lastGradeCardContext", JSON.stringify({from:"student", session, publishBatch:batch}));
  window.location.replace("Grade-card.html"); // ‚úÖ redirect
}

window.onload = function () {
  history.pushState(null, null, location.href);
  window.addEventListener("popstate", function () {
    history.pushState(null, null, location.href);
  });
};

 window.onload = function () {
    if (window.history && window.history.pushState) {
      // Push a state to clear forward history
      history.pushState(null, null, location.href);

      // Handle back button
      window.onpopstate = function () {
        // Allow back button normally
        if (window.history.state === null) {
          return;
        }
        // Block forward navigation
        history.pushState(null, null, location.href);
      };
    }
  };

</script>
</body>
</html>
