<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Forgot Password</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
  (function(){
    emailjs.init({ publicKey: "nimkC_zaNOIPVJP7m" }); // ‚úÖ Tumhara public key
  })();
</script>
<style>
body {
  font-family: 'Poppins', sans-serif;
  min-height: 100vh;
  margin: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  background: linear-gradient(-45deg, #ffecd2, #fcb69f, #ffdde1, #ee9ca7);
  background-size: 1000% 1000%;
  animation: bgFlow 20s ease infinite;
  user-select: none;
}
@keyframes bgFlow {
  0%{background-position:0% 50%;}
  50%{background-position:100% 50%;}
  100%{background-position:0% 50%;}
}
header {
  position: fixed; top: 0; left: 0; width: 100%;
  background: linear-gradient(120deg,#ff9a9e,#fbc2eb,#a1c4fd,#c2e9fb);
  background-size: 400% 400%;
  animation: bgHeader 10s ease infinite;
  text-align: center; color: #fff; padding: 15px; font-size: 28px; font-weight: bold; z-index: 20;
}
@keyframes bgHeader {
  0%{background-position:0% 50%;}
  50%{background-position:100% 50%;}
  100%{background-position:0% 50%;}
}
.container {
  background: rgba(255,255,255,0.95);
  padding: 30px; border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  width: 350px; text-align: center;
  position: relative;
  top: 80px;
}
input {
  width: 100%; padding: 10px; margin: 6px 0; border-radius: 6px; border: 1px solid #ccc;
}
button {
  width: 100%; padding: 10px; background: linear-gradient(90deg, #f7971e, #ffd200);
  color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px;
}
button:hover { opacity: 0.9; }
.msg { margin-top: 10px; font-weight: bold; }
.error { color: red; }
.success { color: green; }
a { text-decoration: none; color: #e46033; font-weight: 600; }
a:hover { text-decoration: underline; }
.timer { font-size: 13px; color: #ff6600; margin-top: 5px; }
</style>
</head>
<body oncontextmenu="return false">

<header>üèõÔ∏è ABC Institute of Technology</header>

<div class="container">
  <h2>Forgot Password</h2>
  <input type="text" id="roll" placeholder="Enter Roll Number">
  <input type="email" id="email" placeholder="Enter Registered Email">
  <div style="display:flex; gap:5px;">
    <input type="text" id="otp" placeholder="Enter OTP" maxlength="6" style="flex:1;">
    <button type="button" style="width:40%; background:#28a745;" id="sendOtpBtn">Send OTP</button>
  </div>
  <div id="otpMsg" class="msg"></div>
  <div id="otpTimer" class="timer"></div>
  <input type="password" id="newpass" placeholder="Enter New Password">
  <input type="password" id="confirmpass" placeholder="Confirm New Password">
  <button id="resetBtn">Reset Password</button>
  <div class="msg" id="msg"></div>
  <p style="margin-top:10px;"><a href="login.html">Back to Login</a></p>
</div>

<script>
let generatedOTP = "";
let otpTimerInterval;

// ‚è≥ Timer
function startTimer(seconds){
  let timer=document.getElementById("otpTimer");
  let btn=document.getElementById("sendOtpBtn");
  btn.disabled=true;
  let remaining=seconds;
  timer.innerText=`Resend OTP in 02:00`;

  otpTimerInterval=setInterval(()=>{
    remaining--;
    let mins=String(Math.floor(remaining/60)).padStart(2,"0");
    let secs=String(remaining%60).padStart(2,"0");
    timer.innerText=`Resend OTP in ${mins}:${secs}`;
    if(remaining<=0){
      clearInterval(otpTimerInterval);
      btn.disabled=false;
      timer.innerHTML=`<button onclick="sendOtp()" style="color:#ff6600;background:none;border:none;font-weight:bold;cursor:pointer;">Resend OTP</button>`;
    }
  },1000);
}

// üìß Send OTP
function sendOtp(){
  let email=document.getElementById("email").value.trim();
  if(!email){
    document.getElementById("otpMsg").innerText="‚ö†Ô∏è Enter email first!";
    document.getElementById("otpMsg").className="msg error";
    return;
  }
  generatedOTP=Math.floor(100000+Math.random()*900000).toString();
  let templateParams={
    user_email:email,
    passcode:generatedOTP,
    time:new Date(Date.now()+5*60000).toLocaleTimeString()
  };
  emailjs.send("service_n2mhzq2","template_iytuvlv",templateParams)
    .then(()=>{document.getElementById("otpMsg").innerText="‚úÖ OTP sent to email!";document.getElementById("otpMsg").className="msg success";})
    .catch((err)=>{document.getElementById("otpMsg").innerText="‚ùå Failed to send OTP";document.getElementById("otpMsg").className="msg error";console.error("EmailJS Error:",err);});
  clearInterval(otpTimerInterval);
  startTimer(120);
}
document.getElementById("sendOtpBtn").addEventListener("click",sendOtp);

// üîë Reset Password
function resetPassword(){
  let roll=document.getElementById("roll").value.trim();
  let email=document.getElementById("email").value.trim();
  let otp=document.getElementById("otp").value.trim();
  let newpass=document.getElementById("newpass").value;
  let confirmpass=document.getElementById("confirmpass").value;

  if(!roll||!email||!otp||!newpass||!confirmpass){
    document.getElementById("msg").innerText="‚ùå Please fill all fields";
    document.getElementById("msg").className="msg error";return;
  }
  let users=JSON.parse(localStorage.getItem("current users"))||[];
  let index=users.findIndex(u=>u.roll===roll&&u.email===email);
  if(index===-1){
    document.getElementById("msg").innerText="‚ùå User not found!";
    document.getElementById("msg").className="msg error";return;
  }
  if(otp!==generatedOTP){
    document.getElementById("msg").innerText="‚ùå Invalid OTP";
    document.getElementById("msg").className="msg error";return;
  }
  if(newpass!==confirmpass){
    document.getElementById("msg").innerText="‚ùå Passwords do not match";
    document.getElementById("msg").className="msg error";return;
  }

  users[index].password=newpass;
  localStorage.setItem("current users",JSON.stringify(users));
  document.getElementById("msg").innerText="‚úÖ Password Reset Successful! Redirecting...";
  document.getElementById("msg").className="msg success";
  setTimeout(()=>{window.location.replace("login.html");},1500);
}
document.getElementById("resetBtn").addEventListener("click",resetPassword);

  (function () {
    // Page load hote hi ek state push karo
    history.pushState(null, null, location.href);

    // Jab user back kare to allow karo (kyunki hum chahte hain back kaam kare)
    window.addEventListener("popstate", function (event) {
        // Fir se ek state daal do taaki forward stack khatam ho jaye
        history.pushState(null, null, location.href);
    });

    // Extra: Agar koi forward dabaye to turant disable ho
    window.addEventListener("pageshow", function (event) {
        if (event.persisted) {
            history.pushState(null, null, location.href);
        }
    });
})();

</script>

</body>
</html>
