<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Grade Card</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  /* --- same CSS as uploaded --- */
  *{box-sizing:border-box}
  @media print{#controls{display:none !important}body{margin:0}}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f8fafc;user-select:none;}
  header{background:linear-gradient(120deg,#ff9a9e,#fbc2eb,#a1c4fd,#c2e9fb);background-size:400% 400%;animation:bg 10s ease infinite;text-align:center;color:#111;padding:16px;font-weight:800;font-size:22px;}
  @keyframes bg{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
  .wrap{max-width:900px;margin:18px auto;padding:0 16px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;overflow:hidden}
  .card .title{background:#111;color:#fff;text-align:center;padding:10px;font-weight:800}
  .row{display:flex;flex-wrap:wrap;padding:14px;gap:12px}
  .cell{flex:1 1 260px;border:1px solid #e5e7eb;border-radius:8px;padding:10px}
  .lbl{font-weight:700;color:#374151}
  .val{font-weight:700}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #e5e7eb;padding:10px;text-align:center}
  th{background:#f3f4f6}
  #controls{display:flex;justify-content:center;gap:10px;margin:14px}
  .btn{border:none;border-radius:8px;padding:10px 14px;font-weight:800;cursor:pointer}
  .btn.blue{background:#2563eb;color:#fff}
</style>
</head>
<body>
<header>üèõÔ∏è ABC Institute of Technology, West Bengal</header>

<div class="wrap">
  <div class="card" id="studCard">
    <div class="title">Grade Card</div>
    <div class="row" id="studRow"></div>
  </div>

  <div style="height:10px"></div>

  <div class="card">
    <table id="tab">
      <thead>
        <tr>
          <th>SL</th>
          <th>Subject</th>
          <th>Letter Grade</th>
          <th>Point</th>
          <th>Credit</th>
          <th>Credit Point</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <th colspan="4" style="text-align:right">Total</th>
          <th id="totCred">0</th>
          <th id="totCredPt">0</th>
        </tr>
      </tfoot>
    </table>
  </div>

  <div style="height:10px"></div>

  <div class="card">
    <table>
      <tr><th style="width:50%">SGPA</th><th style="width:50%">Result</th></tr>
      <tr><td id="sgpa" class="val">-</td><td id="res" class="val">-</td></tr>
    </table>
  </div>

  <div id="controls"><button class="btn blue" onclick="window.print()">Download PDF</button></div>
</div>

<script>
function el(q){return document.querySelector(q)}
function gradeFromPercent(pct){
  if(pct<40) return {grade:'F',point:2};
  const pt=Math.max(4,Math.min(10,Math.round(pct/10)));
  const letter={10:'O',9:'E',8:'A',7:'B',6:'C',5:'D',4:'P'}[pt]||'P';
  return {grade:letter,point:pt};
}

const ctx=JSON.parse(localStorage.getItem("lastGradeCardContext")||"null");
if(!ctx){document.body.innerHTML='<div style="padding:20px;font-weight:800">No grade data.</div>';throw new Error('no ctx');}

let roll=null,sessionFromRow=null,batchFromRow=null,pubDateShown='-';
if(ctx.from==="student"){
  const currentUser=JSON.parse(localStorage.getItem("currentUser")||"{}");
  roll=currentUser?.roll;
  sessionFromRow=ctx.session;
  batchFromRow=ctx.publishBatch;
}
else if(ctx.from==="admin"){
  roll=ctx.record?.roll;
  sessionFromRow=ctx.record?.session;
  batchFromRow=ctx.record?.publishBatch;
}
if(!roll){document.body.innerHTML='<div style="padding:20px;font-weight:800">Invalid context.</div>';throw new Error('bad ctx');}

const all=JSON.parse(localStorage.getItem("allResults")||"[]");
// ‚úÖ fix: sirf current batch ke subjects
const results=all.filter(r=>r.roll===roll && r.published===true && r.session===sessionFromRow && Number(r.publishBatch||0)===Number(batchFromRow));
if(results.length===0){document.body.innerHTML='<div style="padding:20px;font-weight:800">No results found.</div>';throw new Error('no result');}
if(results[0].publicationDate) pubDateShown=new Date(results[0].publicationDate).toLocaleDateString();

const exams=JSON.parse(localStorage.getItem("exams")||"[]");
const CREDIT=3;
const users=JSON.parse(localStorage.getItem("current users")||"[]");
const u=users.find(x=>x.roll===roll)||JSON.parse(localStorage.getItem("currentUser")||"{}");

el('#studRow').innerHTML=`
  <div class="cell"><div class="lbl">Name</div><div class="val">${u?.name||results[0].name||'-'}</div></div>
  <div class="cell"><div class="lbl">Roll</div><div class="val">${roll}</div></div>
  <div class="cell"><div class="lbl">Session</div><div class="val">${sessionFromRow}</div></div>
  <div class="cell"><div class="lbl">Publication Date</div><div class="val">${pubDateShown}</div></div>
`;

const tbody=el('#tab tbody');tbody.innerHTML='';
let totalCred=0,totalCredPt=0,hasFail=false;
results.forEach((r,i)=>{
  const ex=exams.find(e=>e.subject===r.exam);
  const tot=ex?.marks||100;
  const got=Math.round((Number(r.score||0)/Number(r.total||1))*tot);
  const pct=(got/tot)*100;
  const g=gradeFromPercent(pct);
  const credit=CREDIT;
  const cp=g.point*credit;
  tbody.innerHTML+=`<tr><td>${i+1}</td><td>${r.exam}</td><td>${g.grade}</td><td>${g.point}</td><td>${credit}</td><td>${cp}</td></tr>`;
  totalCred+=credit;
  totalCredPt+=cp;
  if(g.grade==='F') hasFail=true;
});

el('#totCred').textContent=totalCred;
el('#totCredPt').textContent=totalCredPt;

// ‚úÖ XP rule: fail => XP + SGPA "-"
if(hasFail){
  el('#res').textContent='XP';
  el('#sgpa').textContent='-';
}else{
  el('#res').textContent='P';
  el('#sgpa').textContent=(totalCredPt/totalCred).toFixed(2);
}

  window.onload = function () {
    if (window.history && window.history.pushState) {
      // Push a state to clear forward history
      history.pushState(null, null, location.href);

      // Handle back button
      window.onpopstate = function () {
        // Allow back button normally
        if (window.history.state === null) {
          return;
        }
        // Block forward navigation
        history.pushState(null, null, location.href);
      };
    }
  };


</script>
</body>
</html>
